version: "3.6"
  
services:
  socket-proxy:
    image: tecnativa/docker-socket-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      SERVICES: 1
      TASKS: 1
      NETWORKS: 1
    networks:
      - mgmt
    deploy:
      placement:
        constraints:
          - node.role == manager

  traefik:
    image: traefik:latest
    command: --docker --docker.endpoint=tcp://socket-proxy:2375 --docker.watch --docker.swarmMode
    ports:
      - 443:443
      - 80:80
    networks:
      - mgmt
      - web
    volumes:
      - ./traefik.toml:/etc/traefik/traefik.toml
      - ./acme.json:/acme.json
      - ./htdigest:/htdigest
    deploy:
      placement:
        constraints:
          - node.role == worker
    labels:
      traefik.enable: "true"
      traefik.port: "8080"
      traefik.frontend.auth.digest.usersFile: "/htdigest"
      traefik.frontend.rule: "Host: traefik.ananas.space, traefik.kenh.fr"

networks:
  mgmt:
    name: mgmt
  web:
    external: true
